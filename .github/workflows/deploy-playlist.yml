name: Ultra-Fast Playlist Deploy

on:
  push:
    branches: [tyo878787]
  schedule:
    - cron: '0 0 * * *'  # Auto-update setiap hari jam 00:00 UTC

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup directories
        run: |
          mkdir -p tmp docs
          echo "ğŸ“ Struktur folder awal:"
          ls -la

      # Download playlist1
      - name: Download Playlist 1
        run: |
          set -e
          curl -f -L "https://raw.githubusercontent.com/tyo878787/my-iptv-playlist/tyo878787/playlist1.m3u" -o tmp/1.m3u
          echo "âœ… Playlist 1 berhasil didownload"

      # Download playlist2 dengan multiple sources
      - name: Download Playlist 2
        run: |
          set -e
          PLAYLIST2_URLS=(
            "https://iptv-org.github.io/iptv/index.m3u"
            "https://raw.githubusercontent.com/iptv-org/iptv/master/index.m3u"
            "https://cdn.jsdelivr.net/gh/iptv-org/iptv/index.m3u"
            "https://gitlab.com/iptv-org/iptv/-/raw/master/index.m3u"
          )
          
          for i in "${!PLAYLIST2_URLS[@]}"; do
            url="${PLAYLIST2_URLS[$i]}"
            echo "Mencoba sumber $((i+1)): $url"
            if curl -f -L "$url" -o tmp/2.m3u; then
              if [ -s tmp/2.m3u ]; then
                echo "âœ… Berhasil download playlist 2 dari sumber $((i+1))"
                exit 0
              else
                echo "âš ï¸ File kosong, coba sumber lain..."
                rm -f tmp/2.m3u
              fi
            else
              echo "âš ï¸ Gagal, coba sumber lain..."
            fi
          done
          
          echo "âŒ Gagal download playlist 2 dari semua sumber"
          exit 1

      - name: Validate playlists
        run: |
          echo "ğŸ” Validasi playlist:"
          if [ ! -s tmp/1.m3u ]; then
            echo "âŒ Playlist 1 kosong atau tidak valid"
            exit 1
          fi
          if [ ! -s tmp/2.m3u ]; then
            echo "âŒ Playlist 2 kosong atau tidak valid"
            exit 1
          fi
          echo "âœ… Kedua playlist valid"
          echo "Ukuran playlist 1: $(ls -lh tmp/1.m3u | awk '{print $5}')"
          echo "Ukuran playlist 2: $(ls -lh tmp/2.m3u | awk '{print $5}')"

      - name: Combine playlists
        run: |
          echo "#EXTM3U" > docs/Finalplay.m3u
          # Hapus baris pertama dan hapus duplikat
          grep -v '^#EXTM3U' tmp/1.m3u | sort -u >> docs/Finalplay.m3u
          grep -v '^#EXTM3U' tmp/2.m3u | sort -u >> docs/Finalplay.m3u
          
          echo "ğŸ”¢ Jumlah entri:"
          echo "Playlist 1: $(grep -c '^#EXTINF' tmp/1.m3u)"
          echo "Playlist 2: $(grep -c '^#EXTINF' tmp/2.m3u)"
          echo "Gabungan: $(grep -c '^#EXTINF' docs/Finalplay.m3u)"
          echo "ğŸ’¾ Ukuran file gabungan: $(ls -lh docs/Finalplay.m3u | awk '{print $5}')"

      - name: Compress playlist
        run: |
          gzip -k -9 docs/Finalplay.m3u
          echo "ğŸ“¦ Ukuran setelah kompresi: $(ls -lh docs/Finalplay.m3u.gz | awk '{print $5}')"

      - name: Copy index.html
        run: |
          if [ ! -f "index.html" ]; then
            echo "âŒ File index.html tidak ditemukan!"
            exit 1
          fi
          cp index.html docs/
          echo "âœ… index.html berhasil disalin"

      - name: Verify docs content
        run: |
          echo "ğŸ“‚ Isi folder docs:"
          ls -lh docs/
          echo ""
          echo "â„¹ï¸ Info file:"
          file docs/Finalplay.m3u
          file docs/Finalplay.m3u.gz
          file docs/index.html

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: docs/
          retention-days: 1

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v2
        id: deployment
        timeout-minutes: 3

      - name: Show deployment info
        run: |
          echo "ğŸš€ Deployment berhasil!"
          echo "Waktu: ${{ steps.deployment.outputs.time }}"
          echo "URL Playlist: https://${{ github.repository_owner }}.github.io/${{ github.repository }}/Finalplay.m3u"
          echo "URL Website: https://${{ github.repository_owner }}.github.io/${{ github.repository }}"
